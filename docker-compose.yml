services:
  redis:
    image: redis:latest
    container_name: redis
    ports:
      - "6379:6379"

  jaeger:
    image: jaegertracing/all-in-one:1.58
    container_name: jaeger
    environment:
      - COLLECTOR_OTLP_ENABLED=true
    ports:
      - "16686:16686" # Jaeger UI
      - "4317:4317"   # OTLP gRPC
      - "4318:4318"   # OTLP HTTP

  prometheus:
    image: prom/prometheus:v2.54.1
    container_name: prometheus
    volumes:
      - ./observability/prometheus.yml:/etc/prometheus/prometheus.yml:ro
    ports:
      - "9090:9090"

  chroma-db:
    image: ghcr.io/chroma-core/chroma:latest
    container_name: chroma-db
    environment:
      - IS_PERSISTENT=TRUE
      - PERSIST_DIRECTORY=/chroma/chroma
    volumes:
      - chroma_data:/chroma/chroma
    ports:
      - "8000:8000"

  qdrant-db:
    image: qdrant/qdrant:latest
    container_name: qdrant-db
    volumes:
      - qdrant_data:/qdrant/storage
    ports:
      - "6333:6333" # REST
      - "6334:6334" # gRPC
    networks:
      - pagi-network

  memory-service:
    container_name: memory-service
    build:
      context: .
      dockerfile: backend-python-memory/Dockerfile
    environment:
      - MEMORY_PORT=8003
      - MEMORY_GRPC_PORT=50052
      - CHROMA_HOST=chroma-db
      - CHROMA_PORT=8000
    ports:
      - "8003:8003"
    depends_on:
      - chroma-db

  rust-sandbox:
    container_name: rust-sandbox
    build:
      context: .
      dockerfile: backend-rust-sandbox/Dockerfile
    environment:
      - RUST_SANDBOX_PORT=8001
      - RUST_SANDBOX_GRPC_PORT=50053
      - LOG_LEVEL=info
    ports:
      - "50053:50053"

  model-gateway:
    container_name: model-gateway
    build:
      context: .
      dockerfile: backend-go-model-gateway/Dockerfile
    environment:
      - MODEL_GATEWAY_GRPC_PORT=50051
      - RAG_GRPC_ADDR=memory-service:50052

      # LLM provider switching
      # Default is "openrouter" (requires OPENROUTER_API_KEY).
      # Set LLM_PROVIDER=mock for development without API keys.
      - LLM_PROVIDER=${LLM_PROVIDER:-openrouter}
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY}
      - OPENROUTER_MODEL_NAME=${OPENROUTER_MODEL_NAME:-mistralai/mistral-7b-instruct:free}
      - OLLAMA_BASE_URL=${OLLAMA_BASE_URL:-http://ollama:11434}
      - OLLAMA_MODEL_NAME=${OLLAMA_MODEL_NAME:-llama3}
      - REQUEST_TIMEOUT_SECONDS=${REQUEST_TIMEOUT_SECONDS:-5}
    ports:
      - "50051:50051"
    depends_on:
      - memory-service

  agent-planner:
    container_name: agent-planner
    build:
      context: .
      dockerfile: backend-go-agent-planner/Dockerfile
    environment:
      - AGENT_PLANNER_PORT=8181
      - MODEL_GATEWAY_ADDR=model-gateway:50051
      - MEMORY_GRPC_ADDR=memory-service:50052
      - MEMORY_URL=http://memory-service:8003
      - RUST_SANDBOX_GRPC_ADDR=rust-sandbox:50053
      - AGENT_MAX_TURNS=${AGENT_MAX_TURNS:-3}
      - AGENT_RAG_TOP_K=${AGENT_RAG_TOP_K:-3}
      - REDIS_ADDR=redis:6379
      - PAGI_AUDIT_DB_PATH=/audit/pagi_audit.db
      # SECURITY: API Key authentication (REQUIRED for production)
      # Generate with: openssl rand -hex 32
      - PAGI_API_KEY=${PAGI_API_KEY:-}

      # OpenTelemetry
      - OTEL_SERVICE_NAME=agent-planner
      - OTEL_EXPORTER_OTLP_ENDPOINT=jaeger:4317
    volumes:
      - agent_planner_audit:/audit
    ports:
      - "8585:8181"
    depends_on:
      - redis
      - memory-service
      - rust-sandbox
      - model-gateway
      - jaeger

  notification-service:
    container_name: notification-service
    build:
      context: .
      dockerfile: backend-go-notification-service/Dockerfile
    environment:
      - REDIS_ADDR=redis:6379
    depends_on:
      - redis

  audit-inspector:
    image: keinos/sqlite3:latest
    container_name: audit-inspector
    volumes:
      - agent_planner_audit:/audit
    entrypoint: ["sh", "-c", "tail -f /dev/null"]
    depends_on:
      - agent-planner

  # --- New Rust Services (Tri-Layer Sovereign Architecture) ---
  
  rust-memory-service:
    container_name: rust-memory-service
    build:
      context: .
      dockerfile: backend-rust-memory/Dockerfile
    env_file:
      - .env
    environment:
      - MEMORY_GRPC_PORT=${MEMORY_GRPC_PORT:-50052}
      - LOG_LEVEL=${LOG_LEVEL:-info}
      # Qdrant (gRPC)
      - QDRANT_URL=${QDRANT_URL:-http://qdrant-db:6334}
      - EMBEDDING_MODEL_DIM=${EMBEDDING_MODEL_DIM:-384}
    ports:
      - "${MEMORY_GRPC_PORT:-50052}:50052"
    depends_on:
      - qdrant-db
    networks:
      - pagi-network

  rust-tools-service:
    container_name: rust-tools-service
    build:
      context: .
      dockerfile: backend-rust-tools/Dockerfile
    env_file:
      - .env
    environment:
      - TOOLS_GRPC_PORT=${TOOLS_GRPC_PORT:-50054}
      - SANDBOX_DIR=/sandbox
      - SAFE_MODE=${SAFE_MODE:-true}
      - LOG_LEVEL=${LOG_LEVEL:-info}
    ports:
      - "${TOOLS_GRPC_PORT:-50054}:50054"
    volumes:
      - tools_sandbox:/sandbox
    networks:
      - pagi-network

  rust-build-service:
    container_name: rust-build-service
    build:
      context: .
      dockerfile: backend-rust-build/Dockerfile
    env_file:
      - .env
    environment:
      - BUILD_SERVICE_PORT=${BUILD_SERVICE_PORT:-50055}
      - TOOLS_REPO_DIR=/app/tools_repo
      - BUILD_TIMEOUT_MS=${BUILD_TIMEOUT_MS:-120000}
      - BUILD_MAX_CONCURRENT=${BUILD_MAX_CONCURRENT:-1}
      - BUILD_MAX_PENDING=${BUILD_MAX_PENDING:-4}
      - LOG_LEVEL=${LOG_LEVEL:-info}
    ports:
      - "${BUILD_SERVICE_PORT:-50055}:50055"
    volumes:
      - tools_repo:/app/tools_repo
    networks:
      - pagi-network

  rust-orchestrator:
    container_name: rust-orchestrator
    build:
      context: .
      dockerfile: backend-rust-orchestrator/Dockerfile
    env_file:
      - .env
    environment:
      - ORCHESTRATOR_HTTP_PORT=${ORCHESTRATOR_HTTP_PORT:-8182}
      - MEMORY_GRPC_ADDR=http://rust-memory-service:50052
      - TOOLS_GRPC_ADDR=http://rust-tools-service:50054
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY}
      - OPENROUTER_MODEL=${OPENROUTER_MODEL:-google/gemini-2.0-flash-exp}
      - OPENROUTER_URL=${OPENROUTER_URL:-https://openrouter.ai/api/v1/chat/completions}
      - LOG_LEVEL=${LOG_LEVEL:-info}
    ports:
      - "${ORCHESTRATOR_HTTP_PORT:-8182}:8182"
    depends_on:
      - rust-memory-service
      - rust-tools-service
    networks:
      - pagi-network

  rust-gateway:
    container_name: rust-gateway
    build:
      context: .
      dockerfile: backend-rust-gateway/Dockerfile
    env_file:
      - .env
    environment:
      - GATEWAY_PORT=${GATEWAY_PORT:-8181}
      - ORCHESTRATOR_URL=http://rust-orchestrator:8182
      - TELEMETRY_URL=http://telemetry:8183
      - LOG_LEVEL=${LOG_LEVEL:-info}
    ports:
      - "${GATEWAY_PORT:-8181}:8181"
    depends_on:
      - rust-orchestrator
      - telemetry
    networks:
      - pagi-network

  telemetry:
    container_name: telemetry
    build:
      context: .
      dockerfile: backend-rust-telemetry/Dockerfile
    env_file:
      - .env
    environment:
      - TELEMETRY_PORT=${TELEMETRY_PORT:-8183}
      - TELEMETRY_INTERVAL_MS=${TELEMETRY_INTERVAL_MS:-2000}
      - LOG_LEVEL=${LOG_LEVEL:-info}
    ports:
      - "${TELEMETRY_PORT:-8183}:8183"
    networks:
      - pagi-network

  frontend:
    container_name: frontend-digital-twin
    build:
      context: ./frontend-digital-twin
      dockerfile: Dockerfile
      args:
        - VITE_WS_URL=${VITE_WS_URL:-ws://localhost:8181/ws/chat}
        - VITE_SSE_URL=${VITE_SSE_URL:-http://localhost:8181/v1/telemetry/stream}
    env_file:
      - .env
    environment:
      - VITE_WS_URL=${VITE_WS_URL:-ws://localhost:8181/ws/chat}
      - VITE_SSE_URL=${VITE_SSE_URL:-http://localhost:8181/v1/telemetry/stream}
    ports:
      - "3000:3000"
    depends_on:
      - rust-gateway
    networks:
      - pagi-network

volumes:
  chroma_data:
  qdrant_data:
  agent_planner_audit:
  tools_sandbox:
  tools_repo:

networks:
  pagi-network:
    driver: bridge
