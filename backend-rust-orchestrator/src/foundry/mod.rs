mod forge_api;
mod compliance_monitor;
mod optimizer;

use axum::{
    extract::Json,
    http::StatusCode,
    response::{IntoResponse, Response},
    routing::{get, post, put},
    Router,
};
use std::sync::Arc;
use tokio::sync::RwLock;
use serde::{Deserialize, Serialize};
use std::fs;
use std::path::PathBuf;
use std::process::Command;
use tokio::sync::broadcast;

use crate::bus::PhoenixEvent;
pub use compliance_monitor::{ComplianceMonitor, AutoRollbackConfig, ComplianceStats};

#[derive(Debug, Deserialize)]
pub struct AgentManifest {
    pub name: String,
    pub role: String,
    pub category: String,
    pub base_prompt: String,
    pub tools: Vec<String>,
}

#[derive(Debug, Deserialize)]
pub struct ToolMetadata {
    pub name: String,
    pub description: String,
    pub language: String,
    pub sudo_required: bool,
    pub network_access: bool,
    pub file_write: bool,
}

#[derive(Debug, Deserialize)]
pub struct ToolForgeRequest {
    pub metadata: ToolMetadata,
    pub code: String,
}

#[derive(Debug, Deserialize)]
pub struct TestPromptRequest {
    pub system_prompt: String,
    pub user_prompt: String,
}

#[derive(Debug, Deserialize)]
pub struct TestToolRequest {
    pub code: String,
    pub language: String,
    pub permissions: ToolPermissions,
}

#[derive(Debug, Deserialize)]
pub struct ToolPermissions {
    pub sudo: bool,
    pub network: bool,
    pub file_write: bool,
}

#[derive(Debug, Serialize)]
pub struct TestToolResponse {
    pub stdout: String,
    pub stderr: String,
}

#[derive(Debug, Serialize)]
pub struct TestPromptResponse {
    pub response: String,
}

pub struct FoundryService {
    event_bus: broadcast::Sender<PhoenixEvent>,
    agent_repo_path: PathBuf,
    tool_repo_path: PathBuf,
}

impl FoundryService {
    pub fn new(
        event_bus: broadcast::Sender<PhoenixEvent>,
        agent_repo_path: PathBuf,
        tool_repo_path: PathBuf,
    ) -> Self {
        Self {
            event_bus,
            agent_repo_path,
            tool_repo_path,
        }
    }

    pub fn router(self) -> Router {
        let service = std::sync::Arc::new(self);
        
        // Create compliance monitor (no circular dependency - just needs the path)
        let compliance_monitor = Arc::new(ComplianceMonitor::new(self.agent_repo_path.clone()));
        
        // Create forge API state
        let forge_state = Arc::new(RwLock::new(forge_api::ForgeState {
            agents_repo_path: self.agent_repo_path.clone(),
            tools_repo_path: self.tool_repo_path.clone(),
            compliance_monitor: compliance_monitor.clone(),
        }));
        
        Router::new()
            // Original forge endpoints
            .route("/api/forge/agent", post({
                let service = service.clone();
                move |payload| Self::forge_agent(service.clone(), payload)
            }))
            .route("/api/forge/tool", post({
                let service = service.clone();
                move |payload| Self::forge_tool(service.clone(), payload)
            }))
            .route("/api/forge/test-prompt", post({
                let service = service.clone();
                move |payload| Self::test_prompt(service.clone(), payload)
            }))
            .route("/api/forge/test-tool", post({
                let service = service.clone();
                move |payload| Self::test_tool(service.clone(), payload)
            }))
            // New evolutionary layer endpoints
            .route("/api/agents", get(forge_api::list_agents))
            .route("/api/agents/:id/history", get(forge_api::get_agent_history))
            .route("/api/agents/:id/diff/:commit", get(forge_api::get_agent_diff))
            .route("/api/agents/:id/revert", post(forge_api::revert_agent))
            .route("/api/agents/:id/test", post(forge_api::test_agent))
            .route("/api/agents/discovery-refresh", post(forge_api::discovery_refresh))
            .route("/api/tools", get(forge_api::list_tools))
            .route("/api/tools/:id", put(forge_api::update_tool))
            .route("/api/tools/:id/mark-legacy", post(forge_api::mark_tool_legacy))
            // Compliance monitoring endpoints
            .route("/api/compliance/config", get(forge_api::get_compliance_config))
            .route("/api/compliance/config", put(forge_api::update_compliance_config))
            .route("/api/agents/:id/compliance", get(forge_api::get_agent_compliance))
            .route("/api/agents/:id/compliance/stats", get(forge_api::get_agent_compliance_stats))
            .with_state(forge_state)
    }
    
    async fn forge_agent(
        service: std::sync::Arc<Self>,
        Json(manifest): Json<AgentManifest>,
    ) -> Response {
        tracing::info!("[FoundryService] Forging agent: {}", manifest.name);

        // Create agent directory
        let agent_dir = service.agent_repo_path.join(&manifest.name);
        if let Err(e) = fs::create_dir_all(&agent_dir) {
            tracing::error!("[FoundryService] Failed to create agent directory: {}", e);
            return (StatusCode::INTERNAL_SERVER_ERROR, format!("Failed to create directory: {}", e)).into_response();
        }

        // Write manifest.yaml
        let manifest_yaml = format!(
            r#"name: {}
role: {}
category: {}
tools:
{}
"#,
            manifest.name,
            manifest.role,
            manifest.category,
            manifest.tools.iter().map(|t| format!("  - {}", t)).collect::<Vec<_>>().join("\n")
        );

        let manifest_path = agent_dir.join("manifest.yaml");
        if let Err(e) = fs::write(&manifest_path, manifest_yaml) {
            tracing::error!("[FoundryService] Failed to write manifest: {}", e);
            return (StatusCode::INTERNAL_SERVER_ERROR, format!("Failed to write manifest: {}", e)).into_response();
        }

        // Write prompt.txt
        let prompt_path = agent_dir.join("prompt.txt");
        if let Err(e) = fs::write(&prompt_path, &manifest.base_prompt) {
            tracing::error!("[FoundryService] Failed to write prompt: {}", e);
            return (StatusCode::INTERNAL_SERVER_ERROR, format!("Failed to write prompt: {}", e)).into_response();
        }

        // Emit discovery refresh event
        let _ = service.event_bus.send(PhoenixEvent::DiscoveryRefresh);

        tracing::info!("[FoundryService] Agent forged successfully: {}", manifest.name);
        (StatusCode::OK, "Agent forged successfully").into_response()
    }

    async fn forge_tool(
        service: std::sync::Arc<Self>,
        Json(request): Json<ToolForgeRequest>,
    ) -> Response {
        tracing::info!("[FoundryService] Forging tool: {}", request.metadata.name);

        // Run syntax check
        let syntax_check_result = match request.metadata.language.as_str() {
            "python" => Self::check_python_syntax(&request.code),
            "rust" => Self::check_rust_syntax(&request.code),
            _ => Err("Unsupported language".to_string()),
        };

        if let Err(e) = syntax_check_result {
            tracing::error!("[FoundryService] Syntax check failed: {}", e);
            return (StatusCode::BAD_REQUEST, format!("Syntax check failed: {}", e)).into_response();
        }

        // Create tool file
        let extension = if request.metadata.language == "python" { "py" } else { "rs" };
        let tool_path = service.tool_repo_path.join(format!("{}.{}", request.metadata.name, extension));

        if let Err(e) = fs::write(&tool_path, &request.code) {
            tracing::error!("[FoundryService] Failed to write tool: {}", e);
            return (StatusCode::INTERNAL_SERVER_ERROR, format!("Failed to write tool: {}", e)).into_response();
        }

        // Update tools.json
        // TODO: Implement tools.json update logic

        // Emit discovery refresh event
        let _ = service.event_bus.send(PhoenixEvent::DiscoveryRefresh);

        tracing::info!("[FoundryService] Tool forged successfully: {}", request.metadata.name);
        (StatusCode::OK, "Tool forged successfully").into_response()
    }

    async fn test_prompt(
        _service: std::sync::Arc<Self>,
        Json(request): Json<TestPromptRequest>,
    ) -> Response {
        tracing::info!("[FoundryService] Testing prompt");

        // TODO: Integrate with LLM service to test the prompt
        // For now, return a mock response
        let response = TestPromptResponse {
            response: format!(
                "Mock response to: {}\n\nSystem prompt: {}",
                request.user_prompt, request.system_prompt
            ),
        };

        Json(response).into_response()
    }

    async fn test_tool(
        _service: std::sync::Arc<Self>,
        Json(request): Json<TestToolRequest>,
    ) -> Response {
        tracing::info!("[FoundryService] Testing tool in sandbox");

        // Execute tool in restricted subprocess
        let result = match request.language.as_str() {
            "python" => Self::execute_python_sandbox(&request.code, &request.permissions),
            "rust" => Self::execute_rust_sandbox(&request.code, &request.permissions),
            _ => Err("Unsupported language".to_string()),
        };

        match result {
            Ok((stdout, stderr)) => {
                let response = TestToolResponse { stdout, stderr };
                Json(response).into_response()
            }
            Err(e) => {
                tracing::error!("[FoundryService] Tool execution failed: {}", e);
                (StatusCode::INTERNAL_SERVER_ERROR, format!("Execution failed: {}", e)).into_response()
            }
        }
    }

    fn check_python_syntax(code: &str) -> Result<(), String> {
        // Write code to temp file
        let temp_file = std::env::temp_dir().join("forge_syntax_check.py");
        fs::write(&temp_file, code).map_err(|e| e.to_string())?;

        // Run python -m py_compile
        let output = Command::new("python3")
            .args(&["-m", "py_compile", temp_file.to_str().unwrap()])
            .output()
            .map_err(|e| e.to_string())?;

        // Clean up
        let _ = fs::remove_file(&temp_file);

        if output.status.success() {
            Ok(())
        } else {
            Err(String::from_utf8_lossy(&output.stderr).to_string())
        }
    }

    fn check_rust_syntax(code: &str) -> Result<(), String> {
        // Write code to temp file
        let temp_file = std::env::temp_dir().join("forge_syntax_check.rs");
        fs::write(&temp_file, code).map_err(|e| e.to_string())?;

        // Run rustc --crate-type lib
        let output = Command::new("rustc")
            .args(&["--crate-type", "lib", "--", temp_file.to_str().unwrap()])
            .output()
            .map_err(|e| e.to_string())?;

        // Clean up
        let _ = fs::remove_file(&temp_file);

        if output.status.success() {
            Ok(())
        } else {
            Err(String::from_utf8_lossy(&output.stderr).to_string())
        }
    }

    fn execute_python_sandbox(code: &str, _permissions: &ToolPermissions) -> Result<(String, String), String> {
        // Write code to temp file
        let temp_file = std::env::temp_dir().join("forge_sandbox.py");
        fs::write(&temp_file, code).map_err(|e| e.to_string())?;

        // Execute in subprocess
        let output = Command::new("python3")
            .arg(temp_file.to_str().unwrap())
            .output()
            .map_err(|e| e.to_string())?;

        // Clean up
        let _ = fs::remove_file(&temp_file);

        Ok((
            String::from_utf8_lossy(&output.stdout).to_string(),
            String::from_utf8_lossy(&output.stderr).to_string(),
        ))
    }

    fn execute_rust_sandbox(code: &str, _permissions: &ToolPermissions) -> Result<(String, String), String> {
        // Write code to temp file
        let temp_file = std::env::temp_dir().join("forge_sandbox.rs");
        fs::write(&temp_file, code).map_err(|e| e.to_string())?;

        // Compile
        let compile_output = Command::new("rustc")
            .args(&["-o", "forge_sandbox_bin", temp_file.to_str().unwrap()])
            .output()
            .map_err(|e| e.to_string())?;

        if !compile_output.status.success() {
            let _ = fs::remove_file(&temp_file);
            return Err(String::from_utf8_lossy(&compile_output.stderr).to_string());
        }

        // Execute
        let output = Command::new("./forge_sandbox_bin")
            .output()
            .map_err(|e| e.to_string())?;

        // Clean up
        let _ = fs::remove_file(&temp_file);
        let _ = fs::remove_file("./forge_sandbox_bin");

        Ok((
            String::from_utf8_lossy(&output.stdout).to_string(),
            String::from_utf8_lossy(&output.stderr).to_string(),
        ))
    }
}
                agents_repo_path: self.agent_repo_path.clone(),
                tools_repo_path: self.tool_repo_path.clone(),
                compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                    agents_repo_path: self.agent_repo_path.clone(),
                    tools_repo_path: self.tool_repo_path.clone(),
                    compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                        agents_repo_path: self.agent_repo_path.clone(),
                        tools_repo_path: self.tool_repo_path.clone(),
                        compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                            agents_repo_path: self.agent_repo_path.clone(),
                            tools_repo_path: self.tool_repo_path.clone(),
                            compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                agents_repo_path: self.agent_repo_path.clone(),
                                tools_repo_path: self.tool_repo_path.clone(),
                                compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                    agents_repo_path: self.agent_repo_path.clone(),
                                    tools_repo_path: self.tool_repo_path.clone(),
                                    compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                        agents_repo_path: self.agent_repo_path.clone(),
                                        tools_repo_path: self.tool_repo_path.clone(),
                                        compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                            agents_repo_path: self.agent_repo_path.clone(),
                                            tools_repo_path: self.tool_repo_path.clone(),
                                            compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                agents_repo_path: self.agent_repo_path.clone(),
                                                tools_repo_path: self.tool_repo_path.clone(),
                                                compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                    agents_repo_path: self.agent_repo_path.clone(),
                                                    tools_repo_path: self.tool_repo_path.clone(),
                                                    compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                        agents_repo_path: self.agent_repo_path.clone(),
                                                        tools_repo_path: self.tool_repo_path.clone(),
                                                        compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                            agents_repo_path: self.agent_repo_path.clone(),
                                                            tools_repo_path: self.tool_repo_path.clone(),
                                                            compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                agents_repo_path: self.agent_repo_path.clone(),
                                                                tools_repo_path: self.tool_repo_path.clone(),
                                                                compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                    agents_repo_path: self.agent_repo_path.clone(),
                                                                    tools_repo_path: self.tool_repo_path.clone(),
                                                                    compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                        agents_repo_path: self.agent_repo_path.clone(),
                                                                        tools_repo_path: self.tool_repo_path.clone(),
                                                                        compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                            agents_repo_path: self.agent_repo_path.clone(),
                                                                            tools_repo_path: self.tool_repo_path.clone(),
                                                                            compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                agents_repo_path: self.agent_repo_path.clone(),
                                                                                tools_repo_path: self.tool_repo_path.clone(),
                                                                                compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                    agents_repo_path: self.agent_repo_path.clone(),
                                                                                    tools_repo_path: self.tool_repo_path.clone(),
                                                                                    compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                        agents_repo_path: self.agent_repo_path.clone(),
                                                                                        tools_repo_path: self.tool_repo_path.clone(),
                                                                                        compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                            agents_repo_path: self.agent_repo_path.clone(),
                                                                                            tools_repo_path: self.tool_repo_path.clone(),
                                                                                            compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                agents_repo_path: self.agent_repo_path.clone(),
                                                                                                tools_repo_path: self.tool_repo_path.clone(),
                                                                                                compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                    agents_repo_path: self.agent_repo_path.clone(),
                                                                                                    tools_repo_path: self.tool_repo_path.clone(),
                                                                                                    compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                        agents_repo_path: self.agent_repo_path.clone(),
                                                                                                        tools_repo_path: self.tool_repo_path.clone(),
                                                                                                        compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                            agents_repo_path: self.agent_repo_path.clone(),
                                                                                                            tools_repo_path: self.tool_repo_path.clone(),
                                                                                                            compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                    agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                    tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                    compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                        agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                        tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                        compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                            agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                            tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                            compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                    agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                    tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                    compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                        agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                        tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                        compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                            agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                            tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                            compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                    agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                    tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                    compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                        agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                        tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                        compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                            agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                            tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                            compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                    agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                    tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                    compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                        agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                        tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                        compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                            agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                            tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                            compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                    agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                    tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                    compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                        agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                        tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                        compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                            agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                            tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                            compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                    agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                    tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                    compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                        agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                        tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                        compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                            agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                            tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                            compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                    agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                    tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                    compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                        agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                        tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                        compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                            agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                            tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                            compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                    agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                    tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                    compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                        agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                        tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                        compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                            agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                            tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                            compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                    agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                    tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                    compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                        agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                        tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                        compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                            agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                            tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                            compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                    agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                    tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                    compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                        agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                        tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                        compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                            agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                            tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                            compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                                agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                                tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                                compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                                    agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                                    tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                                    compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                                        agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                                        tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                                        compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                                            agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                                            tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                                            compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                                                agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                                                tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                                                compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                                                    agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                                                    tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                                                    compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                                                        agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                                                        tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                                                        compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                                                            agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                                                            tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                                                            compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                                                                agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                                                                    agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                    tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                    compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                                                                        agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                        tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                        compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                                                                            agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                            tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                            compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                                                                                agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                                                                                    agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                    tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                    compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                                                                                        agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                        tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                        compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                                                                                            agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                            tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                            compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                                                                                                agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                                                                                                    agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                    tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                    compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                                                                                                        agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                        tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                        compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                                                                                                            agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                            tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                            compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                                                                                                                agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                                                                                                                    agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                    tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                    compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                                                                                                                        agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                        tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                        compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                                                                                                                            agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                            tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                            compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                                                                                                                                agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                                                                                                                                    agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                    tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                    compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                                                                                                                                        agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                        tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                        compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                                                                                                                                            agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                            tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                            compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                                                                                                                                                agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                                                                                                                                                    agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                    tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                    compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                                                                                                                                                        agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                        tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                        compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                                                                                                                                                            agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                            tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                            compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                                                                                                                                                                agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                                                                                                                                                                    agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                    tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                    compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                                                                                                                                                                        agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                        tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                        compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                                                                                                                                                                            agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                            tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                            compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                                                                                                                                                                                agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                                                                                                                                                                                    agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                    tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                    compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                                                                                                                                                                                        agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                        tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                        compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                                                                                                                                                                                            agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                            tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                            compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                                                                                                                                                                                                agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                                                                                                                                                                                                    agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                    tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                    compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                                                                                                                                                                                                        agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                        tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                        compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                                                                                                                                                                                                            agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                            tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                            compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                            agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                            tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                            compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        tools_repo_path: self.tool_repo_path.clone(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        compliance_monitor: Arc::new(ComplianceMonitor::new(Arc::new(RwLock::new(forge_api::ForgeState {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            agents_repo_path: self.agent_repo_path.clone(),
                                                                                                                                 accidental infinite recursion detected

    async fn forge_agent(
        service: std::sync::Arc<Self>,
        Json(manifest): Json<AgentManifest>,
    ) -> Response {
        tracing::info!("[FoundryService] Forging agent: {}", manifest.name);

        // Create agent directory
        let agent_dir = service.agent_repo_path.join(&manifest.name);
        if let Err(e) = fs::create_dir_all(&agent_dir) {
            tracing::error!("[FoundryService] Failed to create agent directory: {}", e);
            return (StatusCode::INTERNAL_SERVER_ERROR, format!("Failed to create directory: {}", e)).into_response();
        }

        // Write manifest.yaml
        let manifest_yaml = format!(
            r#"name: {}
role: {}
category: {}
tools:
{}
"#,
            manifest.name,
            manifest.role,
            manifest.category,
            manifest.tools.iter().map(|t| format!("  - {}", t)).collect::<Vec<_>>().join("\n")
        );

        let manifest_path = agent_dir.join("manifest.yaml");
        if let Err(e) = fs::write(&manifest_path, manifest_yaml) {
            tracing::error!("[FoundryService] Failed to write manifest: {}", e);
            return (StatusCode::INTERNAL_SERVER_ERROR, format!("Failed to write manifest: {}", e)).into_response();
        }

        // Write prompt.txt
        let prompt_path = agent_dir.join("prompt.txt");
        if let Err(e) = fs::write(&prompt_path, &manifest.base_prompt) {
            tracing::error!("[FoundryService] Failed to write prompt: {}", e);
            return (StatusCode::INTERNAL_SERVER_ERROR, format!("Failed to write prompt: {}", e)).into_response();
        }

        // Emit discovery refresh event
        let _ = service.event_bus.send(PhoenixEvent::DiscoveryRefresh);

        tracing::info!("[FoundryService] Agent forged successfully: {}", manifest.name);
        (StatusCode::OK, "Agent forged successfully").into_response()
    }

    async fn forge_tool(
        service: std::sync::Arc<Self>,
        Json(request): Json<ToolForgeRequest>,
    ) -> Response {
        tracing::info!("[FoundryService] Forging tool: {}", request.metadata.name);

        // Run syntax check
        let syntax_check_result = match request.metadata.language.as_str() {
            "python" => Self::check_python_syntax(&request.code),
            "rust" => Self::check_rust_syntax(&request.code),
            _ => Err("Unsupported language".to_string()),
        };

        if let Err(e) = syntax_check_result {
            tracing::error!("[FoundryService] Syntax check failed: {}", e);
            return (StatusCode::BAD_REQUEST, format!("Syntax check failed: {}", e)).into_response();
        }

        // Create tool file
        let extension = if request.metadata.language == "python" { "py" } else { "rs" };
        let tool_path = service.tool_repo_path.join(format!("{}.{}", request.metadata.name, extension));

        if let Err(e) = fs::write(&tool_path, &request.code) {
            tracing::error!("[FoundryService] Failed to write tool: {}", e);
            return (StatusCode::INTERNAL_SERVER_ERROR, format!("Failed to write tool: {}", e)).into_response();
        }

        // Update tools.json
        // TODO: Implement tools.json update logic

        // Emit discovery refresh event
        let _ = service.event_bus.send(PhoenixEvent::DiscoveryRefresh);

        tracing::info!("[FoundryService] Tool forged successfully: {}", request.metadata.name);
        (StatusCode::OK, "Tool forged successfully").into_response()
    }

    async fn test_prompt(
        _service: std::sync::Arc<Self>,
        Json(request): Json<TestPromptRequest>,
    ) -> Response {
        tracing::info!("[FoundryService] Testing prompt");

        // TODO: Integrate with LLM service to test the prompt
        // For now, return a mock response
        let response = TestPromptResponse {
            response: format!(
                "Mock response to: {}\n\nSystem prompt: {}",
                request.user_prompt, request.system_prompt
            ),
        };

        Json(response).into_response()
    }

    async fn test_tool(
        _service: std::sync::Arc<Self>,
        Json(request): Json<TestToolRequest>,
    ) -> Response {
        tracing::info!("[FoundryService] Testing tool in sandbox");

        // Execute tool in restricted subprocess
        let result = match request.language.as_str() {
            "python" => Self::execute_python_sandbox(&request.code, &request.permissions),
            "rust" => Self::execute_rust_sandbox(&request.code, &request.permissions),
            _ => Err("Unsupported language".to_string()),
        };

        match result {
            Ok((stdout, stderr)) => {
                let response = TestToolResponse { stdout, stderr };
                Json(response).into_response()
            }
            Err(e) => {
                tracing::error!("[FoundryService] Tool execution failed: {}", e);
                (StatusCode::INTERNAL_SERVER_ERROR, format!("Execution failed: {}", e)).into_response()
            }
        }
    }

    fn check_python_syntax(code: &str) -> Result<(), String> {
        // Write code to temp file
        let temp_file = std::env::temp_dir().join("forge_syntax_check.py");
        fs::write(&temp_file, code).map_err(|e| e.to_string())?;

        // Run python -m py_compile
        let output = Command::new("python3")
            .args(&["-m", "py_compile", temp_file.to_str().unwrap()])
            .output()
            .map_err(|e| e.to_string())?;

        // Clean up
        let _ = fs::remove_file(&temp_file);

        if output.status.success() {
            Ok(())
        } else {
            Err(String::from_utf8_lossy(&output.stderr).to_string())
        }
    }

    fn check_rust_syntax(code: &str) -> Result<(), String> {
        // Write code to temp file
        let temp_file = std::env::temp_dir().join("forge_syntax_check.rs");
        fs::write(&temp_file, code).map_err(|e| e.to_string())?;

        // Run rustc --crate-type lib
        let output = Command::new("rustc")
            .args(&["--crate-type", "lib", "--", temp_file.to_str().unwrap()])
            .output()
            .map_err(|e| e.to_string())?;

        // Clean up
        let _ = fs::remove_file(&temp_file);

        if output.status.success() {
            Ok(())
        } else {
            Err(String::from_utf8_lossy(&output.stderr).to_string())
        }
    }

    fn execute_python_sandbox(code: &str, _permissions: &ToolPermissions) -> Result<(String, String), String> {
        // Write code to temp file
        let temp_file = std::env::temp_dir().join("forge_sandbox.py");
        fs::write(&temp_file, code).map_err(|e| e.to_string())?;

        // Execute in subprocess
        let output = Command::new("python3")
            .arg(temp_file.to_str().unwrap())
            .output()
            .map_err(|e| e.to_string())?;

        // Clean up
        let _ = fs::remove_file(&temp_file);

        Ok((
            String::from_utf8_lossy(&output.stdout).to_string(),
            String::from_utf8_lossy(&output.stderr).to_string(),
        ))
    }

    fn execute_rust_sandbox(code: &str, _permissions: &ToolPermissions) -> Result<(String, String), String> {
        // Write code to temp file
        let temp_file = std::env::temp_dir().join("forge_sandbox.rs");
        fs::write(&temp_file, code).map_err(|e| e.to_string())?;

        // Compile
        let compile_output = Command::new("rustc")
            .args(&["-o", "forge_sandbox_bin", temp_file.to_str().unwrap()])
            .output()
            .map_err(|e| e.to_string())?;

        if !compile_output.status.success() {
            let _ = fs::remove_file(&temp_file);
            return Err(String::from_utf8_lossy(&compile_output.stderr).to_string());
        }

        // Execute
        let output = Command::new("./forge_sandbox_bin")
            .output()
            .map_err(|e| e.to_string())?;

        // Clean up
        let _ = fs::remove_file(&temp_file);
        let _ = fs::remove_file("./forge_sandbox_bin");

        Ok((
            String::from_utf8_lossy(&output.stdout).to_string(),
            String::from_utf8_lossy(&output.stderr).to_string(),
        ))
    }
}
